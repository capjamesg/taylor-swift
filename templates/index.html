<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- 
      This is an HTML comment
      You can write text in a comment and the content won't be visible in the page
    -->

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="https://glitch.com/favicon.ico" />

    <!--
      This is the page head - it contains info the browser uses
      Like the title, which appears on the browser tab but not inside the page
      Further down you'll see the content that displays in the page
    -->
    <title>How similar is your voice to Taylor Swift?</title>

    <!-- The website stylesheet -->
    <link rel="stylesheet" href="/static/style.css" />

    <!-- The website JavaScript file -->
    <script src="/script.js" defer></script>
  </head>
  <body>
    <div class="wrapper">
      <div class="content" role="main">
        <img
          src="https://upload.wikimedia.org/wikipedia/en/9/9f/Midnights_-_Taylor_Swift.png?20221030194148"
          class="illustration"
          alt="Editor illustration"
          title="Click the image!"
        />
        <div class="instructions">
          <h1 class="title">How similar is your voice to Taylor Swift?</h1>
          <p>
            Record yourself singing a few seconds of a Taylor Swift song to see how similar your voices are.
          </p>
          <p id="similarity" class="title"></p>
          <button onclick="play()" id="play">
            Play âœ…
          </button>
          <h2>
            Leaderboard
          </h2>
          <style>
            ul {
              padding: 0;
            }
            .leaderboard {
              background-color: #f7f7f7;
              list-style-type: none;
              display: flex;
              flex-direction: row;
              border-radius: 10px;
            }
            .leaderboard .number {
              background-color: white;
              flex: 0 10%;
              padding: 10px;
              border-radius: 10px;
            }
            .leaderboard .user {
              flex: 1 70%;
              text-align: right;
              padding: 10px;
            }
            ul:first-child {
              background-color: purple;
            }
            label {
              font-weight: bold;
            }
            button {
              width: 100%;
            }
          </style>
        </div>
      </div>
    </div>
    <!-- The footer holds our remix button â€” you can keep or delete it âœ‚ -->
    <footer class="footer">
      <a
        href="https://jamesg.blog"
      >
        Made by capjamesg
      </a>
    </footer>
    <script>
      var playing = false;
      var mediaRecorder = null;
      var chunks = [];
      
      function play() {
          if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            // playing = true;
            console.log("getUserMedia supported.");
            navigator.mediaDevices
              .getUserMedia(
                {
                  audio: true,
                }
              )

              // Success callback
              .then((stream) => {
                  if (playing) {
                      mediaRecorder.stop();
                  }
                playing = true;
                      var button = document.getElementById("play");
                      button.innerHTML = "Stop ðŸ›‘";

                  mediaRecorder = new MediaRecorder(stream);

                  mediaRecorder.start();

                  mediaRecorder.ondataavailable = (e) => {
                    console.log("data available");
                    chunks.push(e.data);
                  };

                  mediaRecorder.onstop = (e) => {
                      var button = document.getElementById("play");
                      button.innerHTML = "Play ðŸŽ®";

                      // post to server at localhost:5000, send as wav
                      const blob = new Blob(chunks, { type: "audio/wav" });
                      // const audioURL = window.URL.createObjectURL(blob);
                      // audio.src = audioURL;

                      // post as WAV file
                      const formData = new FormData();

                      formData.append("file", blob, "audio.wav");

                      // add . . .. load to #similarity
                      var loading_indicator = document.getElementById("similarity");
                      
                      setTimeout(function() {
                        if (loading_indicator.innerHTML == "Loading.") {
                          loading_indicator.innerHTML = "Loading..";
                        } else if (loading_indicator.innerHTML == "Loading..") {
                          loading_indicator.innerHTML = "Loading...";
                        } else if (loading_indicator.innerHTML == "Loading...") {
                          loading_indicator.innerHTML = "Loading.";
                        } else {
                          loading_indicator.innerHTML = "Loading.";
                        }
                      }, 500);

                      fetch("https://swifties.me", {
                        method: "POST",
                        body: formData,
                      })
                        .then((response) => response.json())
                        .then((data) => {
                          console.log("Success:", data);
                          data.similarity *= 100;
                          document.getElementById("similarity").innerHTML = "Your voice is " + data.similarity + "% similar to Taylor Swift's.";
                  playing = false;
                        })
                        .catch((error) => {
                          console.error(error);
                        });

                      chunks = [];
                  };
              })

              // Error callback
              .catch((err) => {
                console.error(`The following getUserMedia error occurred: ${err}`);
              });
          } else {
            console.log("getUserMedia not supported on your browser!");
          }
      }
    </script>
  </body>
</html>
